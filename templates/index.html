<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>API Sigmoide & Random Forest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 900px; }
        .card { box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .highlight { background-color: #ffeeba; font-weight: bold; }
    </style>
</head>
<body class="container py-5">

    <h1 class="text-center mb-4">Modelo No Lineal & Función Sigmoide</h1>

    <div class="card p-4">
        <h3>1. Dataset (Vista Previa)</h3>
        <div class="table-responsive">
            <table class="table table-sm table-hover" id="dataTable">
                <thead><tr id="tableHead"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <p class="text-muted" id="featuresInfo">Cargando variables correlacionadas...</p>
    </div>

    <div class="card p-4">
        <h3>2. Métricas del Modelo (Random Forest)</h3>
        <p>Modelo pre-entrenado recuperado de MongoDB Atlas.</p>
        <button class="btn btn-primary btn-lg" onclick="getMetrics()">Obtener Métricas</button>
        
        <div class="row mt-4 text-center">
            <div class="col-6">
                <div class="card bg-success text-white p-3">
                    <h5>F1 Score</h5>
                    <h2 id="f1Score">-</h2>
                </div>
            </div>
            <div class="col-6">
                <div class="card bg-info text-white p-3">
                    <h5>Accuracy</h5>
                    <h2 id="accScore">-</h2> </div>
            </div>
        </div>
    </div>

    <div class="card p-4">
        <h3>3. Visualización Sigmoidea Interactiva</h3>
        <p>Mueve el deslizador para desplazar la función de activación en el eje X.</p>
        
        <label for="biasSlider" class="form-label">Desplazamiento (Bias): <span id="biasVal" class="fw-bold">0</span></label>
        <input type="range" class="form-range" id="biasSlider" min="-5" max="5" step="0.5" value="0" oninput="updateGraph(this.value)">
        
        <div id="myPlot" style="width:100%; height:500px; border:1px solid #ddd;"></div>
    </div>

    <script>
        // 1. CARGAR TABLA INICIAL
        async function loadTable() {
            try {
                const res = await fetch('/api/preview/');
                const data = await res.json();
                
                // Headers
                const thead = document.getElementById('tableHead');
                data.columns.forEach(col => {
                    const th = document.createElement('th');
                    th.innerText = col;
                    if(data.correlated_features.includes(col)) th.classList.add('highlight');
                    thead.appendChild(th);
                });

                // Body (solo 5 filas para no saturar)
                const tbody = document.getElementById('tableBody');
                data.rows.slice(0, 5).forEach(row => {
                    const tr = document.createElement('tr');
                    data.columns.forEach(col => {
                        const td = document.createElement('td');
                        td.innerText = row[col];
                        if(data.correlated_features.includes(col)) td.classList.add('highlight');
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                document.getElementById('featuresInfo').innerText = 
                    `Variables correlacionadas utilizadas: ${data.correlated_features.join(' y ')}`;
            } catch (err) {
                console.error("Error cargando tabla", err);
            }
        }

        // 2. OBTENER MÉTRICAS (ACCURACY Y F1)
        async function getMetrics() {
            const btn = document.querySelector('button');
            btn.innerText = "Cargando de Atlas...";
            btn.disabled = true;

            try {
                // Simulamos llamada POST de entrenamiento (ahora es fetch de metadatos)
                const res = await fetch('/api/train/', {method: 'POST', body: '{}'});
                const data = await res.json();
                
                document.getElementById('f1Score').innerText = data.f1_score;
                // AQUI ESTA LA CLAVE DEL ACCURACY
                document.getElementById('accScore').innerText = data.accuracy; 
                
            } catch (err) {
                alert("Error conectando con API");
            } finally {
                btn.innerText = "Actualizar Métricas";
                btn.disabled = false;
            }
        }

        // 3. GRÁFICA SIGMOIDE
        async function updateGraph(shift) {
            document.getElementById('biasVal').innerText = shift;
            
            try {
                const res = await fetch(`/api/sigmoid/?shift=${shift}`);
                const data = await res.json();

                const trace = {
                    x: data.x,
                    y: data.y,
                    mode: 'lines',
                    type: 'scatter',
                    name: 'Sigmoide',
                    line: {color: '#db4437', width: 4}
                };

                const layout = {
                    title: `Función Sigmoidea con Bias = ${shift}`,
                    xaxis: {title: 'Eje X (Feature Ponderado)', range: [-10, 10]},
                    yaxis: {title: 'Probabilidad (0 a 1)', range: [-0.1, 1.1]},
                    margin: {t: 40, r: 20, l: 50, b: 50}
                };

                Plotly.newPlot('myPlot', [trace], layout);
            } catch (err) {
                console.error("Error gráfica", err);
            }
        }

        // Iniciar
        loadTable();
        updateGraph(0); // Pintar gráfica inicial
    </script>
</body>
</html>