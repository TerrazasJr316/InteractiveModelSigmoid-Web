<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Interactive Sigmoid & Random Forest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { background-color: #f4f4f9; color: #333; }
        .highlight { background-color: #d1e7dd !important; font-weight: bold; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="container py-4">

    <h1 class="text-center mb-4">Despliegue API: Separabilidad No Lineal</h1>

    <div class="card p-3">
        <h3>1. Vista Previa del Dataset (ISCXFlowMeter)</h3>
        <p>Cargando datos y detectando correlación...</p>
        <div class="table-responsive">
            <table class="table table-bordered table-sm" id="dataTable">
                <thead><tr id="tableHead"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="alert alert-info" id="corrInfo">
            Calculando correlación...
        </div>
    </div>

    <div class="card p-3">
        <h3>2. Configuración del Modelo (Random Forest)</h3>
        <label class="form-label">Porcentaje de Entrenamiento: <span id="percValue">80</span>%</label>
        <input type="range" class="form-range" id="trainPerc" min="50" max="90" value="80" oninput="document.getElementById('percValue').innerText = this.value">
        
        <button class="btn btn-primary mt-2" onclick="trainModel()">Entrenar Modelo</button>
        
        <div class="mt-3 row text-center">
            <div class="col">
                <h4>F1 Score: <span id="f1Score" class="text-success">-</span></h4>
            </div>
            <div class="col">
                <h4>Accuracy: <span id="accScore" class="text-primary">-</span></h4>
            </div>
        </div>
    </div>

    <div class="card p-3">
        <h3>3. Manipulación Sigmoidea (Eje X)</h3>
        <p>Mueve el deslizador para desplazar la función sigmoidea (visualización del umbral de decisión suave).</p>
        
        <label>Desplazamiento en X (Bias): <span id="biasValue">0</span></label>
        <input type="range" class="form-range" id="biasSlider" min="-5" max="5" step="0.1" value="0" oninput="updateSigmoid(this.value)">

        <div id="plotDiv" style="width:100%;height:500px;"></div>
    </div>

    <script>
        // VARIABLES GLOBALES
        let selectedFeatures = [];

        // 1. CARGAR DATOS AL INICIO
        async function loadData() {
            const res = await fetch('/api/preview/');
            const data = await res.json();
            
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            selectedFeatures = data.correlated_features;

            document.getElementById('corrInfo').innerText = 
                `Variables con alta correlación detectadas: ${selectedFeatures[0]} y ${selectedFeatures[1]}`;

            // Headers
            data.columns.forEach(col => {
                const th = document.createElement('th');
                th.innerText = col;
                if(selectedFeatures.includes(col)) th.classList.add('highlight');
                thead.appendChild(th);
            });

            // Rows
            data.rows.forEach(row => {
                const tr = document.createElement('tr');
                data.columns.forEach(col => {
                    const td = document.createElement('td');
                    td.innerText = row[col];
                    if(selectedFeatures.includes(col)) td.classList.add('highlight');
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            // Inicializar gráfico vacío
            updateSigmoid(0);
        }

        // 2. ENTRENAR MODELO
        async function trainModel() {
            const perc = document.getElementById('trainPerc').value;
            const btn = document.querySelector('button');
            btn.disabled = true;
            btn.innerText = "Entrenando (puede tardar)...";

            try {
                const res = await fetch('/api/train/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({percentage: perc})
                });
                const result = await res.json();

                document.getElementById('f1Score').innerText = result.f1_score;
                document.getElementById('accScore').innerText = result.accuracy;
                
                if(result.f1_score === 1.0) alert("CUIDADO: F1 es 1.0 (Posible Overfitting)");

            } catch (e) {
                console.error(e);
                alert("Error en el entrenamiento");
            } finally {
                btn.disabled = false;
                btn.innerText = "Entrenar Modelo";
            }
        }

        // 3. ACTUALIZAR GRÁFICO SIGMOIDE
        async function updateSigmoid(bias) {
            document.getElementById('biasValue').innerText = bias;
            
            const res = await fetch(`/api/sigmoid/?shift=${bias}`);
            const data = await res.json();

            // Graficamos la sigmoide
            const trace1 = {
                x: data.x,
                y: data.y,
                mode: 'lines',
                name: 'Función Sigmoide',
                line: {color: 'red', width: 3}
            };

            const layout = {
                title: `Sigmoide Desplazada (Bias = ${bias})`,
                xaxis: {title: 'Variable Independiente (Normalizada)'},
                yaxis: {title: 'Probabilidad / Activación', range: [0, 1.1]}
            };

            Plotly.newPlot('plotDiv', [trace1], layout);
        }

        // Iniciar
        loadData();
    </script>
</body>
</html>